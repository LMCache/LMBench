name: Test Self-Hosted Runner

on:
  workflow_dispatch:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  test-runner:
    runs-on: self-hosted
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Conda environment
        shell: bash -l {0}
        run: |
          source ~/miniconda3/etc/profile.d/conda.sh
          conda activate py312
          python --version
          echo "‚úÖ Installing Python dependencies..."
          pip install -r requirements.txt

      - name: Check run-bench.yaml configuration
        shell: bash -l {0}
        run: |
          set -e  # Exit immediately if any command fails
          source ~/miniconda3/etc/profile.d/conda.sh
          conda activate py312

          echo "üîç Checking for run-bench.yaml in $(pwd)..."
          if [ ! -f "run-bench.yaml" ]; then
            echo "::error:: run-bench.yaml not found in project root."
            echo "‚ùå FAILING THE BUILD - run-bench.yaml is required!"
            exit 1
          fi
          echo "‚úÖ Found run-bench.yaml"

          # Check if the infrastructure location is set to LMCacheGKE
          echo "üîç Checking infrastructure location..."
          location=$(python3 -c "
          import yaml
          with open('run-bench.yaml', 'r') as f:
              config = yaml.safe_load(f)
              infrastructure = config.get('1-infrastructure', {})
              print(infrastructure.get('Location', ''))
          ")
          echo "üìç Infrastructure location found: '$location'"

          if [ "$location" != "LMCacheGKE" ]; then
            echo "::error:: Infrastructure location is '$location', not 'LMCacheGKE'. Expected 'LMCacheGKE'."
            echo "‚ùå FAILING THE BUILD - LMCacheGKE configuration required!"
            exit 1
          fi

          echo "‚úÖ run-bench.yaml correctly configured for LMCacheGKE."

      - name: Show runner info
        run: |
          echo "‚úÖ Running on self-hosted runner!"
          uname -a
          whoami
          echo "Current directory: $(pwd)"

      - name: Check gcloud CLI
        run: |
          echo "‚úÖ Checking gcloud installation..."
          gcloud --version

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/816706432769/locations/global/workloadIdentityPools/lmbench-pool/providers/github-provider'
          service_account: 'lmbench-runner@theta-dialect-454217-m5.iam.gserviceaccount.com'

      - name: Show active gcloud account
        run: |
          echo "‚úÖ Checking gcloud auth list..."
          gcloud auth list

      - name: Show active gcloud project
        run: |
          echo "‚úÖ Checking gcloud active project..."
          gcloud config get-value project

      - name: List Compute Engine instances
        run: |
          echo "‚úÖ Listing compute instances..."
          gcloud compute instances list

      - name: Run benchmark script
        shell: bash -l {0}
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          source ~/miniconda3/etc/profile.d/conda.sh
          conda activate py312
          echo "‚úÖ Running benchmark script..."
          python run-bench.py

      - name: Compress benchmark result directories
        run: |
          mkdir -p compressed-artifacts
          for dir in 4-latest-results/*/; do
            name=$(basename "$dir")
            if [ "$name" != "post-processing" ]; then
              tar -czf "compressed-artifacts/$name.tar.gz" -C "4-latest-results" "$name"
            fi
          done

      - name: Upload compressed benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: compressed-artifacts/

  cleanup:
    runs-on: self-hosted
    permissions:
      id-token: write
      contents: read
    if: always()
    needs: [test-runner]
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/816706432769/locations/global/workloadIdentityPools/lmbench-pool/providers/github-provider'
          service_account: 'lmbench-runner@theta-dialect-454217-m5.iam.gserviceaccount.com'

      - name: Run cleanup script
        shell: bash
        run: |
          echo "Running cleanup script to ensure GKE resources are removed..."
          chmod +x ./4-latest-results/post-processing/cleanup.sh
          ./4-latest-results/post-processing/cleanup.sh
          echo "‚úÖ Cleanup completed"
